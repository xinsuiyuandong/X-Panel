{{ template "page/head_start" .}}
<style>
  /* ========================================================================= */
  /* 【核心视觉重构 - 赛博中控台风格 (Cyber-Control-Panel) 】 */
  /* ========================================================================= */
  
  /* --- 颜色变量定义：深色模式 (默认和 .dark, .black) --- */
  :root, .dark, .black {
    --hud-base-bg: #0a0e16; /* 基础背景：极深蓝 */
    --hud-module-bg: rgba(0, 255, 255, 0.04); /* 模块背景：极浅透明青色 */
    --hud-border-color: rgba(0, 255, 255, 0.2); /* 边框：透明青色 */
    --hud-text-primary: white; /* 主文本：白色 */
    --hud-text-dim: rgba(255, 255, 255, 0.6); /* 次要文本：灰色 */
    --hud-glow-color: #00ffff; /* 主辉光：青色 */
    --hud-secondary-color: #ff00ff; /* 次要颜色：品红 */
    --ant-text-color: white; /* 覆盖 Ant 默认文本色 */
  }

  /* --- 颜色变量定义：浅色模式 (适配 .white 主题) --- */
  #app:not(.dark):not(.black) {
    --hud-base-bg: #f0f2f5; /* 基础背景：浅灰色 */
    --hud-module-bg: #ffffff; /* 模块背景：白色 */
    --hud-border-color: rgba(0, 0, 0, 0.15); /* 边框：浅灰黑 */
    --hud-text-primary: #262626; /* 主文本：深灰（高对比度） */
    --hud-text-dim: #595959; /* 次要文本：中灰 */
    --hud-glow-color: #1890ff; /* 主强调色：Ant Blue */
    --hud-secondary-color: #faad14; /* 次要颜色：Ant Yellow */
    --ant-text-color: #262626; /* 覆盖 Ant 默认文本色 */
  }

  /* ==================================================== */
  /* 全局可读性修复：确保所有文字/图标高对比度 */
  /* ==================================================== */

  /* 1. 基础布局和字体 */
  #content-layout, .ant-layout-content {
    background-color: var(--hud-base-bg) !important;
    position: relative;
    color: var(--hud-text-primary); /* 继承主文本色 */
    font-family: 'Consolas', 'Monaco', monospace; 
    padding: 16px; 
    overflow-x: hidden;
  }
  
  /* 2. Ant Design 核心组件文字/图标覆盖 (确保白色主题可读) */
  #app:not(.dark):not(.black) {
    /* 通用文字颜色 */
    color: var(--ant-text-color) !important;
    
    /* 图标颜色 */
    .anticon {
      color: var(--ant-text-color) !important;
    }
    /* Modal 标题/内容文字 */
    .ant-modal-title, .ant-modal-body, .ant-list-item-meta-title, .ant-list-item-meta-description {
      color: var(--ant-text-color) !important;
    }
    /* Log 区域文字输入框 */
    .ant-input {
      color: var(--ant-text-color) !important;
      background-color: rgba(0, 0, 0, 0.03) !important;
      border-color: var(--hud-border-color) !important;
    }
    /* Checkbox/Select 字体 */
    .ant-checkbox-wrapper, .ant-select-selection-selected-value, .ant-select-arrow .anticon {
      color: var(--ant-text-color) !important;
    }
  }

  /* ==================================================== */
  /* 模块样式（棱角化） */
  /* ==================================================== */

  /* 核心模块样式：棱角化边框 (替代 Ant Card) */
  .hud-module {
    background-color: var(--hud-module-bg);
    border: 1px solid var(--hud-border-color);
    padding: 20px;
    margin-bottom: 16px; 
    position: relative;
    z-index: 2;
    overflow: hidden;
    clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    transition: all 0.3s ease;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
  }
  
  /* 深色主题模块特效 */
  .dark .hud-module, .black .hud-module {
    box-shadow: 0 0 5px rgba(0, 255, 255, 0.1);
  }

  /* 模块标题 */
  .hud-title {
    color: var(--hud-glow-color); /* 标题使用强调色 */
    text-transform: uppercase;
    letter-spacing: 2px;
    font-size: 1.1rem;
    margin-bottom: 15px;
    border-bottom: 1px dashed var(--hud-border-color); 
    padding-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* 深色主题标题辉光 */
  .dark .hud-title, .black .hud-title {
    text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
  }
  .hud-title svg {
    font-size: 1.2rem;
    color: var(--hud-secondary-color); /* 图标使用次要强调色 */
  }

  /* 核心数据展示 */
  .hud-stat-large {
    font-size: 3.5rem; 
    font-weight: 900;
    color: var(--hud-text-primary); /* 使用主文本色，浅色模式下为深色，深色模式下为白色 */
    line-height: 1.1;
  }
  
  /* 深色主题大字辉光 */
  .dark .hud-stat-large, .black .hud-stat-large {
    text-shadow: 0 0 15px var(--hud-glow-color);
  }
  .hud-stat-label {
    font-size: 0.8rem;
    color: var(--hud-glow-color); /* 标签使用主强调色 */
    letter-spacing: 1px;
    display: block;
    margin-top: 5px;
    text-transform: uppercase;
  }
  .hud-stat-detail {
    font-size: 0.75rem;
    opacity: 0.8;
    color: var(--hud-text-dim); /* 详情使用次要文本色 */
    margin-top: 5px;
  }
  
  /* 操作/链接按钮 (保留 Ant Design Button) */
  .ant-btn {
    background: transparent !important;
    border-color: var(--hud-glow-color) !important;
    color: var(--hud-text-primary) !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s;
    font-size: 0.9rem;
  }
  
  /* 深色主题按钮特效 */
  .dark .ant-btn, .black .ant-btn {
    background: rgba(0, 255, 255, 0.1) !important;
    text-shadow: 0 0 5px var(--hud-glow-color);
  }
  .ant-btn:hover {
    background: var(--hud-glow-color) !important;
    color: var(--hud-base-bg) !important; /* 悬停时文本颜色切换到背景色（确保高对比度） */
    border-color: var(--hud-glow-color) !important;
  }

  /* 特殊链接标签 */
  .hud-link-tag {
    display: inline-block;
    padding: 5px 10px;
    margin: 4px;
    background: var(--hud-module-bg); 
    border: 1px solid var(--hud-secondary-color);
    color: var(--hud-secondary-color);
    font-size: 0.8rem;
    clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%); 
  }
  
  /* 统一 Ant Modal/Log 容器的背景和边框 */
  .ant-modal-content {
      background: var(--hud-base-bg) !important;
      border: 1px solid var(--hud-border-color);
  }
  .ant-modal-header {
      background: var(--hud-base-bg) !important;
      border-bottom-color: var(--hud-border-color) !important;
  }
  .ant-modal-title {
      color: var(--hud-glow-color) !important;
  }
  
  /* Ant Badge 状态文字 */
  .ant-badge-status-text {
    color: var(--ant-text-color) !important;
    font-weight: bold;
  }
  
  /* 深色主题状态文字辉光 */
  .dark .ant-badge-status-text, .black .ant-badge-status-text {
    color: white !important; /* 确保深色模式下状态文字是白色 */
    text-shadow: 0 0 5px var(--hud-glow-color);
  }

  /* 进度条样式 (不变) */
  .hud-progress-bar-container {
    background-color: var(--hud-border-color); 
    height: 4px; 
    width: 100%;
    margin-top: 5px;
  }
  .hud-progress-bar {
    height: 100%;
    background-color: var(--hud-glow-color);
    transition: width 0.3s ease-out;
  }
  .dark .hud-progress-bar, .black .hud-progress-bar {
    box-shadow: 0 0 8px var(--hud-glow-color);
  }
  
  /* IP 隐藏特效 (不变) */
  .ip-hidden {
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
    filter: blur(10px);
    transition: filter 0.5s ease;
  }
  .ip-hidden:hover {
    filter: blur(0px);
  }

  @media (min-width: 769px) {
    .ant-layout-content {
      margin: 24px 16px;
    }
  }

</style>
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <a-spin :spinning="loadingStates.spinning" :delay="200" :tip="loadingTip">
        
        <transition name="list" appear>
          <a-alert type="error" v-if="showAlert && loadingStates.fetched" :style="{ marginBottom: '16px' }"
            message='{{ i18n "secAlertTitle" }}'
            color="red"
            description='{{ i18n "secAlertSsl" }}'
            show-icon closable>
          </a-alert>
        </transition>

        <a-row v-if="!loadingStates.fetched">
          <div :style="{ textAlign: 'center', padding: '30px 0', marginTop: '10px', color: 'var(--hud-glow-color)' }">
            <a-spin tip='{{ i18n "loading" }}'></a-spin>
          </div>
        </a-row>

        <a-row :gutter="[16, 16]" v-else>

          <a-col :span="24">
            <div class="hud-module" :style="{ padding: '30px 20px', backgroundColor: 'var(--hud-module-bg)' }">
              <div class="hud-title" :style="{ borderBottom: '1px solid var(--hud-border-color)', marginBottom: '20px', fontSize: '1.2rem' }">
                <a-icon type="dashboard" />
                SYSTEM CORE METRICS & LOAD REPORT
              </div>
              <a-row :gutter="[24, 24]">
                <a-col :xs="12" :sm="6" :style="{ textAlign: 'center' }">
                  <div class="hud-stat-large" :style="{ color: status.cpu.color }">[[ status.cpu.percent ]]%</div>
                  <span class="hud-stat-label">{{ i18n "pages.index.cpu" }}</span>
                  <div class="hud-progress-bar-container"><div class="hud-progress-bar" :style="{ width: status.cpu.percent + '%', backgroundColor: status.cpu.color }"></div></div>
                  <a-tooltip>
                    <div class="hud-stat-detail">Cores: [[ CPUFormatter.cpuCoreFormat(status.cpuCores) ]]</div>
                    <template slot="title">
                       <b>{{ i18n "pages.index.logicalProcessors" }}:</b> [[ (status.logicalPro) ]]
                       <br>
                       <b>{{ i18n "pages.index.frequency" }}:</b> [[ CPUFormatter.cpuSpeedFormat(status.cpuSpeedMhz) ]]
                    </template>
                  </a-tooltip>
                </a-col>
                <a-col :xs="12" :sm="6" :style="{ textAlign: 'center' }">
                  <div class="hud-stat-large" :style="{ color: status.mem.color }">[[ status.mem.percent ]]%</div>
                  <span class="hud-stat-label">{{ i18n "pages.index.memory" }}</span>
                  <div class="hud-progress-bar-container"><div class="hud-progress-bar" :style="{ width: status.mem.percent + '%', backgroundColor: status.mem.color }"></div></div>
                  <div class="hud-stat-detail">[[ SizeFormatter.sizeFormat(status.mem.current) ]] / [[ SizeFormatter.sizeFormat(status.mem.total) ]]</div>
                </a-col>
                <a-col :xs="12" :sm="6" :style="{ textAlign: 'center' }">
                  <div class="hud-stat-large" :style="{ color: status.disk.color }">[[ status.disk.percent ]]%</div>
                  <span class="hud-stat-label">{{ i18n "pages.index.storage" }}</span>
                  <div class="hud-progress-bar-container"><div class="hud-progress-bar" :style="{ width: status.disk.percent + '%', backgroundColor: status.disk.color }"></div></div>
                  <div class="hud-stat-detail">[[ SizeFormatter.sizeFormat(status.disk.current) ]] / [[ SizeFormatter.sizeFormat(status.disk.total) ]]</div>
                </a-col>
                <a-col :xs="12" :sm="6" :style="{ textAlign: 'center' }">
                  <div class="hud-stat-large" :style="{ color: status.swap.color }">[[ status.loads[0] ]]</div>
                  <span class="hud-stat-label">Load (1m)</span>
                  <div class="hud-progress-bar-container"><div class="hud-progress-bar" :style="{ width: status.swap.percent + '%', backgroundColor: status.swap.color }"></div></div>
                  <div class="hud-stat-detail">Swap: [[ status.swap.percent ]]%</div>
                  <div class="hud-stat-detail" style="margin-top: 5px; opacity: 1;">
                      <span :style="{ color: 'var(--hud-secondary-color)' }">[[ status.loads[1] ]] / </span> 
                      <span :style="{ color: 'var(--hud-glow-color)' }">[[ status.loads[2] ]]</span>
                  </div>
                </a-col>
              </a-row>
            </div>
          </a-col>

          <a-col :sm="24" :lg="16">
            <a-row :gutter="[16, 16]">
              
              <a-col :sm="24" :md="12">
                <div class="hud-module" :style="{ minHeight: '180px' }">
                  <div class="hud-title"><a-icon type="global" />{{ i18n "pages.index.overallSpeed" }} / {{ i18n "pages.index.totalData" }}</div>
                  <a-row :gutter="[16, 8]">
                    <a-col :span="12" :style="{ textAlign: 'center', borderRight: '1px dashed var(--hud-border-color)' }">
                      <a-icon type="arrow-up" :style="{ color: 'var(--hud-secondary-color)', fontSize: '1.2rem' }" />
                      <div :style="{ color: 'var(--hud-secondary-color)', fontSize: '1.8rem', fontWeight: 700 }">[[ SizeFormatter.sizeFormat(status.netIO.up) ]]/s</div>
                      <span class="hud-stat-label">{{ i18n "pages.index.upload" }}</span>
                      <div class="hud-stat-detail">{{ i18n "pages.index.sent" }}: [[ SizeFormatter.sizeFormat(status.netTraffic.sent) ]]</div>
                    </a-col>
                    <a-col :span="12" :style="{ textAlign: 'center' }">
                      <a-icon type="arrow-down" :style="{ color: 'var(--hud-glow-color)', fontSize: '1.2rem' }" />
                      <div :style="{ color: 'var(--hud-glow-color)', fontSize: '1.8rem', fontWeight: 700 }">[[ SizeFormatter.sizeFormat(status.netIO.down) ]]/s</div>
                      <span class="hud-stat-label">{{ i18n "pages.index.download" }}</span>
                      <div class="hud-stat-detail">{{ i18n "pages.index.received" }}: [[ SizeFormatter.sizeFormat(status.netTraffic.recv) ]]</div>
                    </a-col>
                  </a-row>
                </div>
              </a-col>

              <a-col :sm="24" :md="12">
                <div class="hud-module" :style="{ minHeight: '180px' }">
                  <div class="hud-title">
                    <a-icon type="link" />
                    CONNECTION COUNT & IP
                    <a-tooltip :placement="'top'">
                      <template #title>{{ i18n "pages.index.toggleIpVisibility" }}</template>
                      <a-icon :type="showIp ? 'eye' : 'eye-invisible'" :style="{ fontSize: '1rem', cursor: 'pointer', color: 'var(--ant-text-color)' }" @click="showIp = !showIp"></a-icon>
                    </a-tooltip>
                  </div>
                  <a-row :gutter="[16, 8]">
                    <a-col :span="12" :style="{ textAlign: 'center' }">
                      <div :style="{ color: 'var(--hud-text-primary)', fontSize: '1.5rem', fontWeight: 700 }">[[ status.tcpCount ]]</div>
                      <span class="hud-stat-label">TCP Connections</span>
                    </a-col>
                    <a-col :span="12" :style="{ textAlign: 'center' }">
                      <div :style="{ color: 'var(--hud-text-primary)', fontSize: '1.5rem', fontWeight: 700 }">[[ status.udpCount ]]</div>
                      <span class="hud-stat-label">UDP Connections</span>
                    </a-col>
                    <a-col :span="24">
                       <a-divider style="margin: 10px 0; border-color: var(--hud-border-color);" />
                    </a-col>
                    <a-col :span="12" :class="showIp ? '' : 'ip-hidden'" :style="{ textAlign: 'center' }">
                      <div :style="{ color: 'var(--hud-secondary-color)', fontSize: '0.9rem' }">[[ status.publicIP.ipv4 ]]</div>
                      <span class="hud-stat-detail">Public IPv4</span>
                    </a-col>
                    <a-col :span="12" :class="showIp ? '' : 'ip-hidden'" :style="{ textAlign: 'center' }">
                      <div :style="{ color: 'var(--hud-glow-color)', fontSize: '0.9rem' }">[[ status.publicIP.ipv6 ]]</div>
                      <span class="hud-stat-detail">Public IPv6</span>
                    </a-col>
                  </a-row>
                </div>
              </a-col>

              <a-col :span="24">
                <div class="hud-module">
                  <div class="hud-title"><a-icon type="team" /> Panel Info / Community Links</div>
                  <a-space direction="horizontal" :size="'middle'" :wrap="true">
                    <a rel="noopener" href="https://github.com/xeefei/x-panel/releases" target="_blank">
                      <div class="hud-link-tag" 
                           :style="{ background: 'var(--hud-module-bg)', borderColor: 'var(--hud-secondary-color)', color: 'var(--hud-secondary-color)' }">
                        <a-icon type="github" /> <span>v{{ .cur_ver }} (Releases)</span>
                      </div>
                    </a>
                    <a rel="noopener" href="https://t.me/is_Chat_Bot" target="_blank">
                      <div class="hud-link-tag" :style="{ background: 'var(--hud-module-bg)', borderColor: '#00cc00', color: '#00cc00' }">
                        <a-icon type="message" /> <span>TG 私聊交流</span>
                      </div>
                    </a>
                    <a rel="noopener" href="https://t.me/XUI_CN" target="_blank">
                      <div class="hud-link-tag" 
                           :style="{ background: 'var(--hud-module-bg)', borderColor: 'var(--hud-glow-color)', color: 'var(--hud-glow-color)' }">
                        <a-icon type="team" /> <span>交流群</span>
                      </div>
                    </a>
                    <a rel="noopener" href="https://ping.pe" target="_blank">
                      <div class="hud-link-tag" :style="{ background: 'var(--hud-module-bg)', borderColor: '#ff6600', color: '#ff6600' }">
                        <a-icon type="global" /> <span>端口检测</span>
                      </div>
                    </a>
                  </a-space>
                </div>
              </a-col>
              
            </a-row>
          </a-col>

          <a-col :sm="24" :lg="8">
            <a-row :gutter="[0, 16]">
              
              <a-col :span="24">
                <div class="hud-module">
                  <div class="hud-title"><a-icon type="api" /> Xray Service Control</div>
                  
                  <div class="xray-status-bar">
                    <div>
                      <template v-if="status.xray.state != 'error'">
                        <a-badge status="processing" class="running-animation" :text="status.xray.stateMsg" :color="status.xray.color"/>
                      </template>
                      <template v-else>
                        <a-popover :overlay-class-name="themeSwitcher.currentTheme">
                          <span slot="title">
                            <a-row type="flex" align="middle" justify="space-between">
                              <a-col><span>{{ i18n "pages.index.xrayErrorPopoverTitle" }}</span></a-col>
                              <a-col><a-icon type="bars" :style="{ cursor: 'pointer', float: 'right' }" @click="openLogs()"></a-icon></a-col>
                            </a-row>
                          </span>
                          <template slot="content"><span :style="{ maxWidth: '300px' }" v-for="line in status.xray.errorMsg.split('\n')">[[ line ]]</span></template>
                          <a-badge :text="status.xray.stateMsg" :color="status.xray.color"/>
                        </a-popover>
                      </template>
                    </div>
                    <a-tag :color="status.xray.color">v[[ status.xray.version ]]</a-tag>
                  </div>
                  
                  <div :style="{ marginTop: '20px', display: 'flex', justifyContent: 'space-between', gap: '8px' }">
                    <a-button @click="stopXrayService" icon="poweroff" size="small">{{ i18n "pages.index.stopXray" }}</a-button>
                    <a-button @click="restartXrayService" icon="reload" size="small">{{ i18n "pages.index.restartXray" }}</a-button>
                    <a-button @click="openSelectV2rayVersion" icon="tool" size="small">{{ i18n "pages.index.xraySwitch" }}</a-button>
                  </div>
                </div>
              </a-col>

              <a-col :span="24">
                <div class="hud-module">
                  <div class="hud-title"><a-icon type="control" /> Management Operations</div>
                  <div :style="{ display: 'flex', justifyContent: 'space-between', gap: '8px', flexWrap: 'wrap' }">
                    <a-button @click="openLogs" icon="bars">{{ i18n "pages.index.logs" }}</a-button>
                    <a-button v-if="app.ipLimitEnable" @click="openXrayLogs" icon="bars">{{ i18n "pages.index.xrayLogs" }}</a-button> 
                    <a-button @click="openConfig" icon="file-text">{{ i18n "pages.index.config" }}</a-button>
                    <a-button @click="openBackup" icon="cloud-server">{{ i18n "pages.index.backup" }}</a-button>
                  </div>
                </div>
              </a-col>

              <a-col :span="24">
                <div class="hud-module">
                  <div class="hud-title"><a-icon type="clock-circle" /> Uptime Statistics</div>
                  <div :style="{ display: 'flex', flexDirection: 'column', gap: '10px' }">
                    <div class="hud-stat-detail" :style="{ opacity: 1 }">
                        <span class="hud-link-tag" :style="{ background: 'var(--hud-module-bg)', borderColor: status.xray.color, color: status.xray.color, clipPath: 'polygon(0 0, 90% 0, 100% 100%, 10% 100%)' }">
                            Xray Uptime:
                        </span> 
                        <span :style="{ color: 'var(--hud-text-primary)', fontWeight: 700 }">[[ TimeFormatter.formatSecond(status.appStats.uptime) ]]</span>
                    </div>
                    <div class="hud-stat-detail" :style="{ opacity: 1 }">
                        <span class="hud-link-tag" 
                              :style="{ background: 'var(--hud-module-bg)', borderColor: 'var(--hud-glow-color)', color: 'var(--hud-glow-color)', clipPath: 'polygon(0 0, 90% 0, 100% 100%, 10% 100%)' }">
                            OS Uptime:
                        </span> 
                        <span :style="{ color: 'var(--hud-text-primary)', fontWeight: 700 }">[[ TimeFormatter.formatSecond(status.uptime) ]]</span>
                    </div>
                  </div>
                </div>
              </a-col>

            </a-row>
          </a-col>
        </a-row>
        </a-spin>
    </a-layout-content>
  </a-layout>

  <a-modal id="version-modal" v-model="versionModal.visible" title='{{ i18n "pages.index.xraySwitch" }}' :closable="true"
    @ok="() => versionModal.visible = false" :class="themeSwitcher.currentTheme" footer="">
    <a-collapse default-active-key="1">
      <a-collapse-panel key="1" header='Xray'>
        <a-alert type="warning" :style="{ marginBottom: '12px', width: '100%' }" message='{{ i18n "pages.index.xraySwitchClickDesk" }}' show-icon></a-alert>
        <a-list class="ant-version-list" bordered :style="{ width: '100%' }">
          <a-list-item class="ant-version-list-item" v-for="version, index in versionModal.versions">
            <a-tag :color="index % 2 == 0 ? 'purple' : 'green'">[[ version ]]</a-tag>
            <a-radio :class="themeSwitcher.currentTheme" :checked="version === `v${status.xray.version}`" @click="switchV2rayVersion(version)"></a-radio>
          </a-list-item>
        </a-list>
      </a-collapse-panel>
      <a-collapse-panel key="2" header='Geofiles'>
        <a-list class="ant-version-list" bordered :style="{ width: '100%' }">
          <a-list-item class="ant-version-list-item" v-for="file, index in ['geosite.dat', 'geoip.dat', 'geosite_IR.dat', 'geoip_IR.dat', 'geosite_RU.dat', 'geoip_RU.dat']">
            <a-tag :color="index % 2 == 0 ? 'purple' : 'green'">[[ file ]]</a-tag>
            <a-icon type="reload" @click="updateGeofile(file)" :style="{ marginRight: '8px' }"/>
          </a-list-item>
        </a-list>
        <div style="margin-top: 5px; display: flex; justify-content: flex-end;">
          <a-button @click="updateGeofile('')">{{ i18n "pages.index.geofilesUpdateAll" }}</a-button>
        </div>
      </a-collapse-panel>
    </a-collapse>
  </a-modal>
  <a-modal id="log-modal" v-model="logModal.visible"
    title='{{ i18n "pages.index.logs" }}'
    :closable="true" @cancel="() => logModal.visible = false"
    :class="themeSwitcher.currentTheme"
    width="800px" footer="">
    <template slot="title">
      {{ i18n "pages.index.logs" }}
      <a-icon :spin="logModal.loading"
        type="sync"
        :style="{ verticalAlign: 'middle', marginLeft: '10px' }"
        :disabled="logModal.loading"
        @click="openLogs()">
      </a-icon>
    </template>
    <a-form layout="inline">
      <a-form-item :style="{ marginRight: '0.5rem' }">
        <a-input-group compact>
          <a-select size="small" v-model="logModal.rows" :style="{ width: '70px' }"
            @change="openLogs()" :dropdown-class-name="themeSwitcher.currentTheme">
            <a-select-option value="10">10</a-select-option>
            <a-select-option value="20">20</a-select-option>
            <a-select-option value="50">50</a-select-option>
            <a-select-option value="100">100</a-select-option>
            <a-select-option value="500">500</a-select-option>
          </a-select>
          <a-select size="small" v-model="logModal.level" :style="{ width: '95px' }"
            @change="openLogs()" :dropdown-class-name="themeSwitcher.currentTheme">
            <a-select-option value="debug">Debug</a-select-option>
            <a-select-option value="info">Info</a-select-option>
            <a-select-option value="notice">Notice</a-select-option>
            <a-select-option value="warning">Warning</a-select-option>
            <a-select-option value="err">Error</a-select-option>
          </a-select>
        </a-input-group>
      </a-form-item>
      <a-form-item>
        <a-checkbox v-model="logModal.syslog" @change="openLogs()">SysLog</a-checkbox>
      </a-form-item>
      <a-form-item :style="{ float: 'right' }">
        <a-button type="primary" icon="download" @click="FileManager.downloadTextFile(logModal.logs?.join('\n'), 'x-ui.log')"></a-button>
      </a-form-item>
    </a-form>
    <div class="ant-input" :style="{ height: 'auto', maxHeight: '500px', overflow: 'auto', marginTop: '0.5rem' }" v-html="logModal.formattedLogs"></div>
  </a-modal>
  <a-modal id="xraylog-modal"
    v-model="xraylogModal.visible"
    :closable="true" @cancel="() => xraylogModal.visible = false"
    :class="themeSwitcher.currentTheme"
    width="80vw"
    footer="">
    <template slot="title">
      {{ i18n "pages.index.logs" }}
      <a-icon :spin="xraylogModal.loading"
        type="sync"
        :style="{ verticalAlign: 'middle', marginLeft: '10px' }"
        :disabled="xraylogModal.loading"
        @click="openXrayLogs()">
      </a-icon>
    </template>
    <a-form layout="inline">
      <a-form-item :style="{ marginRight: '0.5rem' }">
        <a-input-group compact>
          <a-select size="small" v-model="xraylogModal.rows" :style="{ width: '70px' }"
            @change="openXrayLogs()" :dropdown-class-name="themeSwitcher.currentTheme">
            <a-select-option value="10">10</a-select-option>
            <a-select-option value="20">20</a-select-option>
            <a-select-option value="50">50</a-select-option>
            <a-select-option value="100">100</a-select-option>
            <a-select-option value="500">500</a-select-option>
          </a-select>
        </a-input-group>
      </a-form-item>
      <a-form-item label="Filter:">
        <a-input size="small" v-model="xraylogModal.filter" @keyup.enter="openXrayLogs()"></a-input>
      </a-form-item>
      <a-form-item>
        <a-checkbox v-model="xraylogModal.showDirect" @change="openXrayLogs()">Direct</a-checkbox>
        <a-checkbox v-model="xraylogModal.showBlocked" @change="openXrayLogs()">Blocked</a-checkbox>
        <a-checkbox v-model="xraylogModal.showProxy" @change="openXrayLogs()">Proxy</a-checkbox>
      </a-form-item>
      <a-form-item :style="{ float: 'right' }">
        <a-button type="primary" icon="download" @click="FileManager.downloadTextFile(xraylogModal.logs?.join('\n'), 'x-ui.log')"></a-button>
      </a-form-item>
    </a-form>
    <div class="ant-input" :style="{ height: 'auto', maxHeight: '500px', overflow: 'auto', marginTop: '0.5rem' }" v-html="xraylogModal.formattedLogs"></div>
  </a-modal>
  <a-modal id="backup-modal" 
    v-model="backupModal.visible" 
    title='{{ i18n "pages.index.backupTitle" }}'
    :closable="true"
    footer=""
    :class="themeSwitcher.currentTheme">
    <a-list class="ant-backup-list" bordered :style="{ width: '100%' }">
      <a-list-item class="ant-backup-list-item">
        <a-list-item-meta>
          <template #title>{{ i18n "pages.index.exportDatabase" }}</template>
          <template #description>{{ i18n "pages.index.exportDatabaseDesc" }}</template>
        </a-list-item-meta>
        <a-button @click="exportDatabase()" type="primary" icon="download"/>
      </a-list-item>
      <a-list-item class="ant-backup-list-item">
        <a-list-item-meta>
          <template #title>{{ i18n "pages.index.importDatabase" }}</template>
          <template #description>{{ i18n "pages.index.importDatabaseDesc" }}</template>
        </a-list-item-meta>
        <a-button @click="importDatabase()" type="primary" icon="upload" />
      </a-list-item>
    </a-list>
  </a-modal>
</a-layout>
  
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
{{template "component/aCustomStatistic" .}}
{{template "modals/textModal"}}
<script>
    class CurTotal {

        constructor(current, total) {
            this.current = current;
            this.total = total;
        }

        get percent() {
            if (this.total === 0) {
                return 0;
            }
            return NumberFormatter.toFixed(this.current / this.total * 100, 2);
        }

        get color() {
            const percent = this.percent;
            if (percent < 80) {
                return '#008771'; // Green
            } else if (percent < 90) {
                return "#f37b24"; // Orange
            } else {
                return "#cf3c3c"; // Red
            }
        }
    }

    class Status {
        constructor(data) {
            this.cpu = new CurTotal(0, 0);
            this.cpuCores = 0;
            this.logicalPro = 0;
            this.cpuSpeedMhz = 0;
            this.disk = new CurTotal(0, 0);
            this.loads = [0, 0, 0];
            this.mem = new CurTotal(0, 0);
            this.netIO = { up: 0, down: 0 };
            this.netTraffic = { sent: 0, recv: 0 };
            this.publicIP = { ipv4: 0, ipv6: 0 };
            this.swap = new CurTotal(0, 0);
            this.tcpCount = 0;
            this.udpCount = 0;
            this.uptime = 0;
            this.appUptime = 0;
            this.appStats = {threads: 0, mem: 0, uptime: 0};

            this.xray = { state: 'stop', stateMsg: "", errorMsg: "", version: "", color: "" };

            if (data == null) {
              return;
            }

            this.cpu = new CurTotal(data.cpu, 100);
            this.cpuCores = data.cpuCores;
            this.logicalPro = data.logicalPro;
            this.cpuSpeedMhz = data.cpuSpeedMhz;
            this.disk = new CurTotal(data.disk.current, data.disk.total);
            this.loads = data.loads.map(load => NumberFormatter.toFixed(load, 2));
            this.mem = new CurTotal(data.mem.current, data.mem.total);
            this.netIO = data.netIO;
            this.netTraffic = data.netTraffic;
            this.publicIP = data.publicIP;
            this.swap = new CurTotal(data.swap.current, data.swap.total);
            this.tcpCount = data.tcpCount;
            this.udpCount = data.udpCount;
            this.uptime = data.uptime;
            this.appUptime = data.appUptime;
            this.appStats = data.appStats;
            this.xray = data.xray;
            switch (this.xray.state) {
                case 'running':
                    this.xray.color = "green";
                    this.xray.stateMsg = '{{ i18n "pages.index.xrayStatusRunning" }}';
                    break;
                case 'stop':
                    this.xray.color = "orange";
                    this.xray.stateMsg = '{{ i18n "pages.index.xrayStatusStop" }}';
                    break;
                case 'error':
                    this.xray.color = "red";
                    this.xray.stateMsg ='{{ i18n "pages.index.xrayStatusError" }}';
                    break;
                default:
                    this.xray.color = "gray";
                    this.xray.stateMsg = '{{ i18n "pages.index.xrayStatusUnknown" }}';
                    break;
            }
        }
    }

    const versionModal = {
        visible: false,
        versions: [],
        show(versions) {
            this.visible = true;
            this.versions = versions;
        },
        hide() {
            this.visible = false;
        },
    };

    const logModal = {
        visible: false,
        logs: [],
        rows: 20,
        level: 'info',
        syslog: false,
        loading: false,
        show(logs) {
            this.visible = true;
            this.logs = logs; 
            this.formattedLogs = this.logs?.length > 0 ? this.formatLogs(this.logs) : "No Record...";
        },
        formatLogs(logs) {
            let formattedLogs = '';
            const levels = ["DEBUG","INFO","NOTICE","WARNING","ERROR"];
            const levelColors = ["#3c89e8","#008771","#008771","#f37b24","#e04141","#bcbcbc"];

            logs.forEach((log, index) => {
                let [data, message] = log.split(" - ",2);
                const parts = data.split(" ")
                if(index>0) formattedLogs += '<br>';

                if (parts.length === 3) {
                    const d = parts[0];
                    const t = parts[1];
                    const level = parts[2];
                    const levelIndex = levels.indexOf(level,levels) || 5;

                    //formattedLogs += `<span style="color: gray;">${index + 1}.</span>`;
                    formattedLogs += `<span style="color: ${levelColors[0]};">${d} ${t}</span> `;
                    formattedLogs += `<span style="color: ${levelColors[levelIndex]}">${level}</span>`;
                } else {
                    const levelIndex = levels.indexOf(data,levels) || 5;
                    formattedLogs += `<span style="color: ${levelColors[levelIndex]}">${data}</span>`;
                }

                if(message){
                    if(message.startsWith("XRAY:"))
                        message = "<b>XRAY: </b>" + message.substring(5);
                    else
                        message = "<b>X-UI: </b>" + message;
                }

                formattedLogs += message ? ' - ' + message : '';
            });

            return formattedLogs;
        },
        hide() {
            this.visible = false;
        },
    };

    const xraylogModal = {
        visible: false,
        logs: [],
        rows: 20,
        showDirect: true,
        showBlocked: true,
        showProxy: true,
        loading: false,
        show(logs) {
            this.visible = true;
            this.logs = logs;
            this.formattedLogs = this.logs?.length > 0 ? this.formatLogs(this.logs) : "No Record...";
        },
        formatLogs(logs) {
            let formattedLogs = '';

          logs.forEach((log, index) => {
            if(index > 0) formattedLogs += '<br>';

            const parts = log.split(' ');

            if(parts.length === 10) {
              const dateTime = `<b>${parts[0]} ${parts[1]}</b>`;
              const from = `<b>${parts[3]}</b>`;
              const to = `<b>${parts[5].replace(/^\/+/, "")}</b>`;

              let outboundColor = '';
              if (parts[9] === "b") {
                outboundColor = ' style="color: #e04141;"'; //red for blocked
              }
              else if (parts[9] === "p") {
                outboundColor = ' style="color: #3c89e8;"'; //blue for proxies
              }

              formattedLogs += `<span${outboundColor}>
${dateTime}
 ${parts[2]}
 ${from}
 ${parts[4]}
 ${to}
 ${parts.slice(6, 9).join(' ')}
</span>`;
            } else {
              formattedLogs += `<span>${log}</span>`;
            }
          });

            return formattedLogs;
        },
        hide() {
            this.visible = false;
        },
    };

    const backupModal = {
        visible: false,
        show() {
          this.visible = true;
        },
        hide() {
          this.visible = false;
        },
    };

    const app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        mixins: [MediaQueryMixin],
        data: {
            themeSwitcher,
            loadingStates: {
              fetched: false,
              spinning: false
            },
            status: new Status(),
            versionModal,
            logModal,
            xraylogModal,
            backupModal,
            loadingTip: '{{ i18n "loading"}}',
            showAlert: false,
            showIp: false,
            ipLimitEnable: false,
        },
        methods: {
            loading(spinning, tip = '{{ i18n "loading"}}') {
                this.loadingStates.spinning = spinning;
                this.loadingTip = tip;
            },
            async getStatus() {
                try {
                    const msg = await HttpUtil.get('/panel/api/server/status');
                    if (msg.success) {
                        if (!this.loadingStates.fetched) {
                            this.loadingStates.fetched = true;
                        }

                        this.setStatus(msg.obj, true);
                    }
                } catch (e) {
                    console.error("Failed to get status:", e);
                }
            },
            setStatus(data) {
                this.status = new Status(data);
            },
            async openSelectV2rayVersion() {
                this.loading(true);
                const msg = await HttpUtil.get('/panel/api/server/getXrayVersion');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
                versionModal.show(msg.obj);
            },
            switchV2rayVersion(version) {
                this.$confirm({
                    title: '{{ i18n "pages.index.xraySwitchVersionDialog"}}',
                    content: '{{ i18n "pages.index.xraySwitchVersionDialogDesc"}}'.replace('#version#', version),
                    okText: '{{ i18n "confirm"}}',
                    class: themeSwitcher.currentTheme,
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: async () => {
                        versionModal.hide();
                        this.loading(true, '{{ i18n "pages.index.dontRefresh"}}');
                        await HttpUtil.post(`/panel/api/server/installXray/${version}`);
                        this.loading(false);
                    },
                });
            },
            updateGeofile(fileName) {
                const isSingleFile = !!fileName;
                this.$confirm({
                    title: '{{ i18n "pages.index.geofileUpdateDialog" }}',
                    content: isSingleFile
                        ? '{{ i18n "pages.index.geofileUpdateDialogDesc" }}'.replace("#filename#", fileName)
                        : '{{ i18n "pages.index.geofilesUpdateDialogDesc" }}',
                    okText: '{{ i18n "confirm"}}',
                    class: themeSwitcher.currentTheme,
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: async () => {
                        versionModal.hide();
                        this.loading(true, '{{ i18n "pages.index.dontRefresh"}}');
                        const url = isSingleFile 
                            ? `/panel/api/server/updateGeofile/${fileName}` 
                            : `/panel/api/server/updateGeofile`;
                        await HttpUtil.post(url);
                        this.loading(false);
                    },
                });
            },
            async stopXrayService() {
                this.loading(true);
                const msg = await HttpUtil.post('/panel/api/server/stopXrayService');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
            },
            async restartXrayService() {
                this.loading(true);
                const msg = await HttpUtil.post('/panel/api/server/restartXrayService');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
            },
            async openLogs(){
                logModal.loading = true;
                const msg = await HttpUtil.post('/panel/api/server/logs/'+logModal.rows,{level: logModal.level, syslog: logModal.syslog});
                if (!msg.success) {
                    return;
                }
                logModal.show(msg.obj);
                await PromiseUtil.sleep(500);
                logModal.loading = false;
            },
            async openXrayLogs(){
              xraylogModal.loading = true;
                const msg = await HttpUtil.post('/panel/api/server/xraylogs/'+xraylogModal.rows,{filter: xraylogModal.filter, showDirect: xraylogModal.showDirect, showBlocked: xraylogModal.showBlocked, showProxy: xraylogModal.showProxy});
                if (!msg.success) {
                    return;
                }
              xraylogModal.show(msg.obj);
                await PromiseUtil.sleep(500);
              xraylogModal.loading = false;
            },
            async openConfig() {
                this.loading(true);
                const msg = await HttpUtil.get('/panel/api/server/getConfigJson');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
                txtModal.show('config.json', JSON.stringify(msg.obj, null, 2), 'config.json');
            },
            openBackup() {
              backupModal.show();
            },
            exportDatabase() {
                window.location = basePath.replace(/\/$/, '') + '/panel/api/server/getDb';
            },
            importDatabase() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.db';
                fileInput.addEventListener('change', async (event) => {
                    const dbFile = event.target.files[0];
                    if (dbFile) {
                        const formData = new FormData();
                        formData.append('db', dbFile);
                        backupModal.hide();
                        this.loading(true);
                        const uploadMsg = await HttpUtil.post('/panel/api/server/importDB', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data',
                            }
                        });
                        this.loading(false);
                        if (!uploadMsg.success) {
                            return;
                        }
                        this.loading(true);
                        const restartMsg = await HttpUtil.post("/panel/setting/restartPanel");
                        this.loading(false);
                        if (restartMsg.success) {
                            this.loading(true);
                            await PromiseUtil.sleep(5000);
                            location.reload();
                        }
                    }
                });
                fileInput.click();
            },
        },
        async mounted() {
            if (window.location.protocol !== "https:") {
                this.showAlert = true;
            }

            const msg = await HttpUtil.post('/panel/setting/defaultSettings');
            if (msg.success) {
              this.ipLimitEnable = msg.obj.ipLimitEnable;
            }

            while (true) {
                try {
                    await this.getStatus();
                } catch (e) {
                    console.error(e);
                }
                await PromiseUtil.sleep(2000);
            }
        },
    });
</script>
{{ template "page/body_end" .}}

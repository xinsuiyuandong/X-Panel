{{ template "page/head_start" .}}
<style>

    /* 【通用】动态流光背景，作为所有主题的底色，增加炫酷感 */
    body {
        background: linear-gradient(-45deg, #EB5C20, #ABA0D9, #23a6d5, #23d5ab, #F0C9CF, #A9CD71, #00ffff);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* 【通用】让内容区透明，以透出动态背景 */
    #app, .ant-layout, .ant-layout-content {
        background: transparent !important;
    }

    /* ==================================================================
       核心修正 1：顶部间距 (10px) - (保持不变)
       ================================================================== */
    .ant-layout-content {
        padding-top: 10px !important; 
    }

    /* ==================================================================
       核心修正 2：卡片背景 
       ================================================================== */
    
    /* 1. 卡片基础样式：作为容器，透明背景，**取消所有边框效果** */
    .glass-card {
        border-radius: 16px !important;
        transition: all 0.3s ease;
        position: relative !important;
        border: none !important; /* 移除原生边框 */
        background: transparent !important; /* 确保卡片本身透明，透出背景动画 */
        overflow: hidden; 
        z-index: 1; 
        box-shadow: none !important; /* 移除所有动态/静态边框阴影 */
        animation: none !important; /* 移除所有边框动画 */
    }
    .glass-card:hover {
        transform: translateY(-5px); 
    }

    /* 2. 玻璃背景层 (::before) - 负责玻璃模糊和半透明底色 */
    .glass-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 16px;
        z-index: -1; /* 位于内容下方 */
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
    }

    /* 3. 确保内容在最前面 */
    .glass-card .ant-card-head,
    .glass-card .ant-card-body {
        position: relative;
        z-index: 1;
        background: transparent !important;
    }

    /* 【主题兼容：亮色-light】玻璃内背景，高度透明让主体渐变透出 */
    .light .glass-card::before {
        background: rgba(255, 255, 255, 0.2) !important; 
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15) !important;
    }
    /* 【主题兼容：暗色-dark / 黑色-black】玻璃内背景，高度透明让主体渐变透出 */
    .dark .glass-card::before,
    .black .glass-card::before {
        background: rgba(0, 0, 0, 0.1) !important; 
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37) !important;
    }

    /* 字体颜色覆盖 (保持不变) */
    .light .glass-card * {
        color: #2c3e50 !important;
    }
    .dark .glass-card *,
    .black .glass-card * {
        color: #ecf0f1 !important;
    }
    .light .glass-card .ant-statistic-content-value,
    .dark .glass-card .ant-statistic-content-value,
    .black .glass-card .ant-statistic-content-value {
        color: inherit !important;
    }

    /* ==================================================================
       ★ 新增修正：解决问题 1, 2, 3
       ================================================================== */

    /* 解决问题 3: 移除【X-Panel面板】卡片标题下方的“下划线” (实际是边框) */
    .glass-card .ant-card-head {
        border-bottom: none !important;
    }

    /* 解决问题 1 & 2: 修正【Xray】和【管理】卡片底部操作文字的颜色，使其在所有主题下都清晰可见 */
    /* 同时移除操作栏顶部的分割线，保持玻璃效果的纯粹性 */
    .glass-card .ant-card-actions {
        border-top: none !important;
        background: transparent !important; /* 确保操作栏背景也透明 */
    }

    /* 为亮色主题设置深色文字和交互效果 */
    .light .glass-card .ant-card-actions span {
        color: rgba(0, 0, 0, 0.65) !important;
        transition: color 0.3s;
    }
    .light .glass-card .ant-card-actions > li > span:hover span,
    .light .glass-card .ant-card-actions > li > span:hover .anticon {
        color: #1890ff !important; /* Ant Design 默认的悬停蓝色 */
    }

    /* 为暗色/黑色主题设置亮色文字和交互效果 */
    .dark .glass-card .ant-card-actions span,
    .black .glass-card .ant-card-actions span {
        color: rgba(255, 255, 255, 0.85) !important; /* 使用半透明白色以获得更好的视觉效果 */
        transition: color 0.3s;
    }
    .dark .glass-card .ant-card-actions > li > span:hover span,
    .black .glass-card .ant-card-actions > li > span:hover span,
    .dark .glass-card .ant-card-actions > li > span:hover .anticon,
    .black .glass-card .ant-card-actions > li > span:hover .anticon {
        color: #40a9ff !important; /* Ant Design 暗色主题下的悬停亮蓝色 */
    }


    /* ==================================================================
       ★ 核心修正 4：底部严格对齐 (Flexbox Equal Height)
       ================================================================== */
    
    /* 外层容器：确保内层 Ant-Row 可以被拉伸 (保持不变) */
    .main-content-row {
        display: flex;
        flex-direction: column; 
        flex-grow: 1;
    }

    /* 内层容器：包含两列的 Ant-Row，强制其为 flex 布局并拉伸子项 */
    .main-content-row > .ant-row { 
        display: flex !important;
        align-items: stretch !important; /* 核心：使所有列（Ant-Col）等高 */
        flex-grow: 1;
        flex-wrap: wrap; /* 确保在移动设备上可以正常换行 */
    }

    /* 目标列（Ant-Col）：设置为 flex 布局，以便控制其内部卡片的排列 */
    .main-content-row > .ant-row > .ant-col {
        display: flex;
        flex-direction: column; 
        /* 移除了 height: 100%，因为 align-items: stretch 已经处理了高度，这样更可靠 */
    }

    /* 让【右侧】列的最后一个卡片（即 Ant-Col:nth-child(2)）自动伸长，以填补剩余的垂直空间 */
    .main-content-row > .ant-row > .ant-col:nth-child(2) > .glass-card:last-child {
        flex-grow: 1; 
    }

    /* 移除两个主列中，所有卡片或组件的最后一个元素的底部边距，以实现完美对齐 */
    .main-content-row > .ant-row > .ant-col > *:last-child {
        margin-bottom: 0 !important;
    }

    /* 确保被拉伸卡片的内容区域也跟着拉伸，并垂直居中（如果需要） */
    .main-content-row > .ant-row > .ant-col:nth-child(2) > .glass-card:last-child .ant-card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }


    /* 【通用】原始的必要样式保留 */
    .ip-hidden { filter: blur(10px); user-select: none; }
    .running-animation .ant-badge-status-dot { animation: runningAnimation 1.2s linear infinite; }
    @keyframes runningAnimation { 0%,50%,100% {transform: scale(1);opacity: 1;} 10% {transform: scale(1.5);opacity: .2;} }

    /* === X-Panel LOGO 炫酷效果样式 (保留) === */
    @keyframes neonGlow {
        0%, 100% {
            text-shadow: 0 0 5px #00aaff, 0 0 10px #00aaff, 0 0 20px #00aaff, 0 0 40px #00aaff;
        }
        50% {
            text-shadow: 0 0 10px #ff0077, 0 0 20px #ff0077, 0 0 40px #ff0077, 0 0 80px #ff0077;
        }
    }

    .x-panel-logo-text {
        font-size: 3rem; 
        font-weight: 900;
        margin: 0;
        color: #fff; 
        text-transform: capitalize;
        letter-spacing: 2px;
        animation: neonGlow 5s ease-in-out infinite alternate;
        text-align: center;
        line-height: 1.2;
    }

    .x-panel-desc {
        text-align: center;
        font-size: 1rem;
        color: inherit;
        line-height: 1.5;
    }
    .x-panel-desc b {
        font-weight: normal;
    }
	
</style>
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme">
	<a-sidebar></a-sidebar>
	<a-layout id="content-layout">
		<a-layout-content>
			<a-spin :spinning="loadingStates.spinning" :delay="200" :tip="loadingTip">
				<transition name="list" appear>
					<a-alert type="error" v-if="showAlert && loadingStates.fetched" :style="{ marginBottom: '10px' }"
						message='{{ i18n "secAlertTitle" }}'
						color="red"
						description='{{ i18n "secAlertSsl" }}'
						show-icon closable>
					</a-alert>
				</transition>
				<transition name="list" appear>
					<template>
						<a-row v-if="!loadingStates.fetched">
							<a-card :style="{ textAlign: 'center', padding: '30px 0', marginTop: '10px', background: 'transparent', border: 'none' }">
								<a-spin tip='{{ i18n "loading" }}'></a-spin>
							</a-card>
						</a-row>
						<a-row v-else class="main-content-row">
							<a-row :gutter="[isMobile ? 8 : 16, isMobile ? 8 : 16]" :style="{ flex: '1 1 100%' }">

								<a-col :sm="24" :lg="16">
									<a-card hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px', paddingBottom: '16px' }">
										<div class="x-panel-logo-text">X-Panel</div>
										<br>
										<div class="x-panel-desc">
											<b>一个更好的面板</b>
											<br><br>
											<b>基于 Xray Core 构建</b>
										</div>
									</a-card>

									<a-card title='{{ i18n "pages.index.serverStatus" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<a-row :gutter="[0, isMobile ? 16 : 0]">
											<a-col :sm="24" :md="12">
												<a-row>
													<a-col :span="12" :style="{ textAlign: 'center' }">
														<a-progress type="dashboard" status="normal"
															:stroke-color="status.cpu.color"
															:percent="status.cpu.percent"></a-progress>
														<div>
															<b>{{ i18n "pages.index.cpu" }}:</b> [[ CPUFormatter.cpuCoreFormat(status.cpuCores) ]]
															<a-tooltip>
																<a-icon type="area-chart"></a-icon>
																<template slot="title">
																	<div><b>{{ i18n "pages.index.logicalProcessors" }}:</b> [[ (status.logicalPro) ]]</div>
																	<div><b>{{ i18n "pages.index.frequency" }}:</b> [[ CPUFormatter.cpuSpeedFormat(status.cpuSpeedMhz) ]]</div>
																</template>
															</a-tooltip>
														</div>
													</a-col>
													<a-col :span="12" :style="{ textAlign: 'center' }">
														<a-progress type="dashboard" status="normal"
															:stroke-color="status.mem.color"
															:percent="status.mem.percent"></a-progress>
														<div>
															<b>{{ i18n "pages.index.memory"}}:</b> [[ SizeFormatter.sizeFormat(status.mem.current) ]] / [[ SizeFormatter.sizeFormat(status.mem.total) ]]
														</div>
													</a-col>
												</a-row>
											</a-col>
											<a-col :sm="24" :md="12">
												<a-row>
													<a-col :span="12" :style="{ textAlign: 'center' }">
														<a-progress type="dashboard" status="normal"
															:stroke-color="status.swap.color"
															:percent="status.swap.percent"></a-progress>
														<div>
															<b>{{ i18n "pages.index.swap" }}:</b> [[ SizeFormatter.sizeFormat(status.swap.current) ]] / [[ SizeFormatter.sizeFormat(status.swap.total) ]]
														</div>
													</a-col>
													<a-col :span="12" :style="{ textAlign: 'center' }">
														<a-progress type="dashboard" status="normal"
															:stroke-color="status.disk.color"
															:percent="status.disk.percent"></a-progress>
														<div>
															<b>{{ i18n "pages.index.storage"}}:</b> [[ SizeFormatter.sizeFormat(status.disk.current) ]] / [[ SizeFormatter.sizeFormat(status.disk.total) ]]
														</div>
													</a-col>
												</a-row>
											</a-col>
										</a-row>
									</a-card>

									<a-card title='{{ i18n "pages.index.xrayStatus" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<template #extra>
											<template v-if="status.xray.state != 'error'">
												<a-badge status="processing" class="running-animation" :text="status.xray.stateMsg" :color="status.xray.color"/>
											</template>
											<template v-else>
												<a-popover :overlay-class-name="themeSwitcher.currentTheme">
													<span slot="title">
														<a-row type="flex" align="middle" justify="space-between">
															<a-col><span>{{ i18n "pages.index.xrayErrorPopoverTitle" }}</span></a-col>
															<a-col><a-icon type="bars" :style="{ cursor: 'pointer', float: 'right' }" @click="openLogs()"></a-icon></a-col>
														</a-row>
													</span>
													<template slot="content">
														<span :style="{ maxWidth: '400px' }" v-for="line in status.xray.errorMsg.split('\n')">[[ line ]]</span>
													</template>
													<a-badge :text="status.xray.stateMsg" :color="status.xray.color"/>
												</a-popover>
											</template>
										</template>
										<a-tag v-if="status.xray.version != 'Unknown'" color="green">v[[ status.xray.version ]]</a-tag>
										<template #actions>
											<a-space v-if="app.ipLimitEnable" direction="horizontal" @click="openXrayLogs()" :style="{ justifyContent: 'center' }">
												<a-icon type="bars"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.logs" }}</span>
											</a-space>
											<a-space direction="horizontal" @click="stopXrayService" :style="{ justifyContent: 'center' }">
												<a-icon type="poweroff"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.stopXray" }}</span>
											</a-space>
											<a-space direction="horizontal" @click="restartXrayService" :style="{ justifyContent: 'center' }">
												<a-icon type="reload"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.restartXray" }}</span>
											</a-space>
											<a-space direction="horizontal" @click="openSelectV2rayVersion" :style="{ justifyContent: 'center' }">
												<a-icon type="tool"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.xraySwitch" }}</span>
											</a-space>
										</template>
									</a-card>

									<a-card title='{{ i18n "menu.link" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<template #actions>
											<a-space direction="horizontal" @click="openLogs()" :style="{ justifyContent: 'center' }">
												<a-icon type="bars"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.logs" }}</span>
											</a-space>
											<a-space direction="horizontal" @click="openConfig" :style="{ justifyContent: 'center' }">
												<a-icon type="control"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.config" }}</span>
											</a-space>
											<a-space direction="horizontal" @click="openBackup" :style="{ justifyContent: 'center' }">
												<a-icon type="cloud-server"></a-icon><span v-if="!isMobile">{{ i18n "pages.index.backup" }}</span>
											</a-space>
										</template>
									</a-card>

									<a-row :gutter="[isMobile ? 8 : 16, 0]" :style="{ flexShrink: 0, width: '100%' }">
										<a-col :sm="24" :md="12">
											<a-card title='{{ i18n "pages.index.totalData" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: isMobile ? '16px' : '0' }">
												<a-row :gutter="isMobile ? [8,8] : 0">
													<a-col :span="12">
														<a-custom-statistic title='{{ i18n "pages.index.sent" }}' :value="SizeFormatter.sizeFormat(status.netTraffic.sent)">
															<template #prefix><a-icon type="cloud-upload" /></template>
														</a-custom-statistic>
													</a-col>
													<a-col :span="12">
														<a-custom-statistic title='{{ i18n "pages.index.received" }}' :value="SizeFormatter.sizeFormat(status.netTraffic.recv)">
															<template #prefix><a-icon type="cloud-download" /></template>
														</a-custom-statistic>
													</a-col>
												</a-row>
											</a-card>
										</a-col>
										<a-col :sm="24" :md="12">
											<a-card title='{{ i18n "pages.index.connectionCount" }}' hoverable :bordered="true" class="glass-card">
												<a-row :gutter="isMobile ? [8,8] : 0">
													<a-col :span="12">
														<a-custom-statistic title="TCP" :value="status.tcpCount">
															<template #prefix><a-icon type="swap" /></template>
														</a-custom-statistic>
													</a-col>
													<a-col :span="12">
														<a-custom-statistic title="UDP" :value="status.udpCount">
															<template #prefix><a-icon type="swap" /></template>
														</a-custom-statistic>
													</a-col>
												</a-row>
											</a-card>
										</a-col>
									</a-row>

								</a-col>

								<a-col :sm="24" :lg="8">
									<a-card title='〔X-Panel面板〕' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<div style="white-space: nowrap; overflow-x: auto;">
											<a rel="noopener" href="https://github.com/xeefei/x-panel/releases" target="_blank">
												<a-tag color="green"><span>v{{ .cur_ver }}</span></a-tag>
											</a>
											<a rel="noopener" href="https://t.me/is_Chat_Bot" target="_blank">
												<a-tag color="green"><span>TG私聊交流</span></a-tag>
											</a>
											<a rel="noopener" href="https://t.me/XUI_CN" target="_blank">
												<a-tag color="purple"><span>〔X-Panel面板〕交流群</span></a-tag>
											</a>
										</div>
									</a-card>

									<a-card title='{{ i18n "pages.index.operationHours" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<a-tag :color="status.xray.color">Xray: [[ TimeFormatter.formatSecond(status.appStats.uptime) ]]</a-tag>
										<a-tag color="green">OS: [[ TimeFormatter.formatSecond(status.uptime) ]]</a-tag>
									</a-card>

									<a-card title='{{ i18n "pages.index.systemLoad" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<div style="white-space: nowrap; overflow-x: auto;"> 
											<a-tag color="green">
												<a-tooltip>
													[[ status.loads[0] ]] | [[ status.loads[1] ]] | [[ status.loads[2] ]]
													<template slot="title">
														{{ i18n "pages.index.systemLoadDesc" }}
													</template>
												</a-tooltip>
											</a-tag>
											<a rel="noopener" href="https://ping.pe" target="_blank"><a-tag color="green">端口检测</a-tag></a>
											<a rel="noopener" href="https://www.speedtest.net" target="_blank"><a-tag color="green">网络测速</a-tag></a>
										</div>
									</a-card>

									<a-card title='{{ i18n "usage"}}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<a-tag color="green"> {{ i18n "pages.index.memory" }}: [[ SizeFormatter.sizeFormat(status.appStats.mem) ]] </a-tag>
										<a-tag color="green"> {{ i18n "pages.index.threads" }}: [[ status.appStats.threads ]] </a-tag>
									</a-card>

									<a-card title='{{ i18n "pages.index.overallSpeed" }}' hoverable :bordered="true" class="glass-card" :style="{ marginBottom: '16px' }">
										<a-row :gutter="isMobile ? [8,8] : 0">
											<a-col :span="12">
												<a-custom-statistic title='{{ i18n "pages.index.upload" }}' :value="SizeFormatter.sizeFormat(status.netIO.up)">
													<template #prefix><a-icon type="arrow-up" /></template>
													<template #suffix>/s</template>
												</a-custom-statistic>
											</a-col>
											<a-col :span="12">
												<a-custom-statistic title='{{ i18n "pages.index.download" }}' :value="SizeFormatter.sizeFormat(status.netIO.down)">
													<template #prefix><a-icon type="arrow-down" /></template>
													<template #suffix>/s</template>
												</a-custom-statistic>
											</a-col>
										</a-row>
									</a-card>

									<a-card title='{{ i18n "pages.index.ipAddresses" }}' hoverable :bordered="true" class="glass-card">
										<template #extra>
											<a-tooltip :placement="isMobile ? 'topRight' : 'top'">
												<template #title>{{ i18n "pages.index.toggleIpVisibility" }}</template>
												<a-icon :type="showIp ? 'eye' : 'eye-invisible'" :style="{ fontSize: '1rem' }" @click="showIp = !showIp"></a-icon>
											</a-tooltip>
										</template>
										<a-row :class="showIp ? 'ip-visible' : 'ip-hidden'" :gutter="isMobile ? [8,8] : 0">
											<a-col :span="isMobile ? 24 : 12">
												<a-custom-statistic title="IPv4" :value="status.publicIP.ipv4">
													<template #prefix><a-icon type="global" /></template>
												</a-custom-statistic>
											</a-col>
											<a-col :span="isMobile ? 24 : 12">
												<a-custom-statistic title="IPv6" :value="status.publicIP.ipv6">
													<template #prefix><a-icon type="global" /></template>
												</a-custom-statistic>
											</a-col>
										</a-row>
									</a-card>

								</a-col>
							</a-row>


						</a-row>
						</template>
				</transition>
			</a-spin>
		</a-layout-content>
	</a-layout>
	<a-modal id="version-modal" v-model="versionModal.visible" title='{{ i18n "pages.index.xraySwitch" }}' :closable="true"
		@ok="() => versionModal.visible = false" :class="themeSwitcher.currentTheme" footer="">
		<a-collapse default-active-key="1">
			<a-collapse-panel key="1" header='Xray'>
				<a-alert type="warning" :style="{ marginBottom: '12px', width: '100%' }" message='{{ i18n "pages.index.xraySwitchClickDesk" }}' show-icon></a-alert>
				<a-list class="ant-version-list" bordered :style="{ width: '100%' }">
					<a-list-item class="ant-version-list-item" v-for="version, index in versionModal.versions">
						<a-tag :color="index % 2 == 0 ? 'purple' : 'green'">[[ version ]]</a-tag>
						<a-radio :class="themeSwitcher.currentTheme" :checked="version === `v${status.xray.version}`" @click="switchV2rayVersion(version)"></a-radio>
					</a-list-item>
				</a-list>
			</a-collapse-panel>
			<a-collapse-panel key="2" header='Geofiles'>
				<a-list class="ant-version-list" bordered :style="{ width: '100%' }">
					<a-list-item class="ant-version-list-item" v-for="file, index in ['geosite.dat', 'geoip.dat', 'geosite_IR.dat', 'geoip_IR.dat', 'geosite_RU.dat', 'geoip_RU.dat']">
						<a-tag :color="index % 2 == 0 ? 'purple' : 'green'">[[ file ]]</a-tag>
						<a-icon type="reload" @click="updateGeofile(file)" :style="{ marginRight: '8px' }"/>
					</a-list-item>
				</a-list>
				<div style="margin-top: 5px; display: flex; justify-content: flex-end;">
					<a-button @click="updateGeofile('')">{{ i18n "pages.index.geofilesUpdateAll" }}</a-button>
				</div>
			</a-collapse-panel>
		</a-collapse>
	</a-modal>
	<a-modal id="log-modal" v-model="logModal.visible"
		:closable="true" @cancel="() => logModal.visible = false"
		:class="themeSwitcher.currentTheme"
		width="800px" footer="">
		<template slot="title">
			{{ i18n "pages.index.logs" }}
			<a-icon :spin="logModal.loading"
				type="sync"
				:style="{ verticalAlign: 'middle', marginLeft: '10px' }"
				:disabled="logModal.loading"
				@click="openLogs()">
			</a-icon>
		</template>
		<a-form layout="inline">
			<a-form-item :style="{ marginRight: '0.5rem' }">
				<a-input-group compact>
					<a-select size="small" v-model="logModal.rows" :style="{ width: '70px' }"
						@change="openLogs()" :dropdown-class-name="themeSwitcher.currentTheme">
						<a-select-option value="10">10</a-select-option>
						<a-select-option value="20">20</a-select-option>
						<a-select-option value="50">50</a-select-option>
						<a-select-option value="100">100</a-select-option>
						<a-select-option value="500">500</a-select-option>
					</a-select>
					<a-select size="small" v-model="logModal.level" :style="{ width: '95px' }"
						@change="openLogs()" :dropdown-class-name="themeSwitcher.currentTheme">
						<a-select-option value="debug">Debug</a-select-option>
						<a-select-option value="info">Info</a-select-option>
						<a-select-option value="notice">Notice</a-select-option>
						<a-select-option value="warning">Warning</a-select-option>
						<a-select-option value="err">Error</a-select-option>
					</a-select>
				</a-input-group>
			</a-form-item>
			<a-form-item>
				<a-checkbox v-model="logModal.syslog" @change="openLogs()">SysLog</a-checkbox>
			</a-form-item>
			<a-form-item :style="{ float: 'right' }">
				<a-button type="primary" icon="download" @click="FileManager.downloadTextFile(logModal.logs?.join('\n'), 'x-ui.log')"></a-button>
			</a-form-item>
		</a-form>
		<div class="ant-input" :style="{ height: 'auto', maxHeight: '500px', overflow: 'auto', marginTop: '0.5rem' }" v-html="logModal.formattedLogs"></div>
	</a-modal>
	<a-modal id="xraylog-modal"
		v-model="xraylogModal.visible"
		:closable="true" @cancel="() => xraylogModal.visible = false"
		:class="themeSwitcher.currentTheme"
		width="80vw"
		footer="">
		<template slot="title">
			{{ i18n "pages.index.logs" }}
			<a-icon :spin="xraylogModal.loading"
				type="sync"
				:style="{ verticalAlign: 'middle', marginLeft: '10px' }"
				:disabled="xraylogModal.loading"
				@click="openXrayLogs()">
			</a-icon>
		</template>
		<a-form layout="inline">
			<a-form-item :style="{ marginRight: '0.5rem' }">
				<a-input-group compact>
					<a-select size="small" v-model="xraylogModal.rows" :style="{ width: '70px' }"
						@change="openXrayLogs()" :dropdown-class-name="themeSwitcher.currentTheme">
						<a-select-option value="10">10</a-select-option>
						<a-select-option value="20">20</a-select-option>
						<a-select-option value="50">50</a-select-option>
						<a-select-option value="100">100</a-select-option>
						<a-select-option value="500">500</a-select-option>
					</a-select>
				</a-input-group>
			</a-form-item>
			<a-form-item label="Filter:">
				<a-input size="small" v-model="xraylogModal.filter" @keyup.enter="openXrayLogs()"></a-input>
			</a-form-item>
			<a-form-item>
				<a-checkbox v-model="xraylogModal.showDirect" @change="openXrayLogs()">Direct</a-checkbox>
				<a-checkbox v-model="xraylogModal.showBlocked" @change="openXrayLogs()">Blocked</a-checkbox>
				<a-checkbox v-model="xraylogModal.showProxy" @change="openXrayLogs()">Proxy</a-checkbox>
			</a-form-item>
			<a-form-item :style="{ float: 'right' }">
				<a-button type="primary" icon="download" @click="FileManager.downloadTextFile(xraylogModal.logs?.join('\n'), 'x-ui.log')"></a-button>
			</a-form-item>
		</a-form>
		<div class="ant-input" :style="{ height: 'auto', maxHeight: '500px', overflow: 'auto', marginTop: '0.5rem' }" v-html="xraylogModal.formattedLogs"></div>
	</a-modal>
	<a-modal id="backup-modal"
		v-model="backupModal.visible"
		title='{{ i18n "pages.index.backupTitle" }}'
		:closable="true"
		footer=""
		:class="themeSwitcher.currentTheme">
		<a-list class="ant-backup-list" bordered :style="{ width: '100%' }">
			<a-list-item class="ant-backup-list-item">
				<a-list-item-meta>
					<template #title>{{ i18n "pages.index.exportDatabase" }}</template>
					<template #description>{{ i18n "pages.index.exportDatabaseDesc" }}</template>
				</a-list-item-meta>
				<a-button @click="exportDatabase()" type="primary" icon="download"/>
			</a-list-item>
			<a-list-item class="ant-backup-list-item">
				<a-list-item-meta>
					<template #title>{{ i18n "pages.index.importDatabase" }}</template>
					<template #description>{{ i18n "pages.index.importDatabaseDesc" }}</template>
				</a-list-item-meta>
				<a-button @click="importDatabase()" type="primary" icon="upload" />
			</a-list-item>
		</a-list>
	</a-modal>
</a-layout>
  
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
{{template "component/aCustomStatistic" .}}
{{template "modals/textModal"}}
<script>
    class CurTotal {

        constructor(current, total) {
            this.current = current;
            this.total = total;
        }

        get percent() {
            if (this.total === 0) {
                return 0;
            }
            return NumberFormatter.toFixed(this.current / this.total * 100, 2);
        }

        get color() {
            const percent = this.percent;
            if (percent < 80) {
                return '#008771'; // Green
            } else if (percent < 90) {
                return "#f37b24"; // Orange
            } else {
                return "#cf3c3c"; // Red
            }
        }
    }

    class Status {
        constructor(data) {
            this.cpu = new CurTotal(0, 0);
            this.cpuCores = 0;
            this.logicalPro = 0;
            this.cpuSpeedMhz = 0;
            this.disk = new CurTotal(0, 0);
            this.loads = [0, 0, 0];
            this.mem = new CurTotal(0, 0);
            this.netIO = { up: 0, down: 0 };
            this.netTraffic = { sent: 0, recv: 0 };
            this.publicIP = { ipv4: 0, ipv6: 0 };
            this.swap = new CurTotal(0, 0);
            this.tcpCount = 0;
            this.udpCount = 0;
            this.uptime = 0;
            this.appUptime = 0;
            this.appStats = {threads: 0, mem: 0, uptime: 0};

            this.xray = { state: 'stop', stateMsg: "", errorMsg: "", version: "", color: "" };

            if (data == null) {
              return;
            }

            this.cpu = new CurTotal(data.cpu, 100);
            this.cpuCores = data.cpuCores;
            this.logicalPro = data.logicalPro;
            this.cpuSpeedMhz = data.cpuSpeedMhz;
            this.disk = new CurTotal(data.disk.current, data.disk.total);
            this.loads = data.loads.map(load => NumberFormatter.toFixed(load, 2));
            this.mem = new CurTotal(data.mem.current, data.mem.total);
            this.netIO = data.netIO;
            this.netTraffic = data.netTraffic;
            this.publicIP = data.publicIP;
            this.swap = new CurTotal(data.swap.current, data.swap.total);
            this.tcpCount = data.tcpCount;
            this.udpCount = data.udpCount;
            this.uptime = data.uptime;
            this.appUptime = data.appUptime;
            this.appStats = data.appStats;
            this.xray = data.xray;
            switch (this.xray.state) {
                case 'running':
                    this.xray.color = "green";
                    this.xray.stateMsg = '{{ i18n "pages.index.xrayStatusRunning" }}';
                    break;
                case 'stop':
                    this.xray.color = "orange";
                    this.xray.stateMsg = '{{ i18n "pages.index.xrayStatusStop" }}';
                    break;
                case 'error':
                    this.xray.color = "red";
                    this.xray.stateMsg ='{{ i18n "pages.index.xrayStatusError" }}';
                    break;
                default:
                    this.xray.color = "gray";
                    this.xray.stateMsg = '{{ i18n "pages.index.xrayStatusUnknown" }}';
                    break;
            }
        }
    }

    const versionModal = {
        visible: false,
        versions: [],
        show(versions) {
            this.visible = true;
            this.versions = versions;
        },
        hide() {
            this.visible = false;
        },
    };

    const logModal = {
        visible: false,
        logs: [],
        rows: 20,
        level: 'info',
        syslog: false,
        loading: false,
        show(logs) {
            this.visible = true;
            this.logs = logs; 
            this.formattedLogs = this.logs?.length > 0 ? this.formatLogs(this.logs) : "No Record...";
        },
        formatLogs(logs) {
            let formattedLogs = '';
            const levels = ["DEBUG","INFO","NOTICE","WARNING","ERROR"];
            const levelColors = ["#3c89e8","#008771","#008771","#f37b24","#e04141","#bcbcbc"];

            logs.forEach((log, index) => {
                let [data, message] = log.split(" - ",2);
                const parts = data.split(" ")
                if(index>0) formattedLogs += '<br>';

                if (parts.length === 3) {
                    const d = parts[0];
                    const t = parts[1];
                    const level = parts[2];
                    const levelIndex = levels.indexOf(level,levels) || 5;

                    //formattedLogs += `<span style="color: gray;">${index + 1}.</span>`;
                    formattedLogs += `<span style="color: ${levelColors[0]};">${d} ${t}</span> `;
                    formattedLogs += `<span style="color: ${levelColors[levelIndex]}">${level}</span>`;
                } else {
                    const levelIndex = levels.indexOf(data,levels) || 5;
                    formattedLogs += `<span style="color: ${levelColors[levelIndex]}">${data}</span>`;
                }

                if(message){
                    if(message.startsWith("XRAY:"))
                        message = "<b>XRAY: </b>" + message.substring(5);
                    else
                        message = "<b>X-UI: </b>" + message;
                }

                formattedLogs += message ? ' - ' + message : '';
            });

            return formattedLogs;
        },
        hide() {
            this.visible = false;
        },
    };

    const xraylogModal = {
        visible: false,
        logs: [],
        rows: 20,
        showDirect: true,
        showBlocked: true,
        showProxy: true,
        loading: false,
        show(logs) {
            this.visible = true;
            this.logs = logs;
            this.formattedLogs = this.logs?.length > 0 ? this.formatLogs(this.logs) : "No Record...";
        },
        formatLogs(logs) {
            let formattedLogs = '';

          logs.forEach((log, index) => {
            if(index > 0) formattedLogs += '<br>';

            const parts = log.split(' ');

            if(parts.length === 10) {
              const dateTime = `<b>${parts[0]} ${parts[1]}</b>`;
              const from = `<b>${parts[3]}</b>`;
              const to = `<b>${parts[5].replace(/^\/+/, "")}</b>`;

              let outboundColor = '';
              if (parts[9] === "b") {
                outboundColor = ' style="color: #e04141;"'; //red for blocked
              }
              else if (parts[9] === "p") {
                outboundColor = ' style="color: #3c89e8;"'; //blue for proxies
              }

              formattedLogs += `<span${outboundColor}>
${dateTime}
 ${parts[2]}
 ${from}
 ${parts[4]}
 ${to}
 ${parts.slice(6, 9).join(' ')}
</span>`;
            } else {
              formattedLogs += `<span>${log}</span>`;
            }
          });

            return formattedLogs;
        },
        hide() {
            this.visible = false;
        },
    };

    const backupModal = {
        visible: false,
        show() {
          this.visible = true;
        },
        hide() {
          this.visible = false;
        },
    };

    const app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        mixins: [MediaQueryMixin],
        data: {
            themeSwitcher,
            loadingStates: {
              fetched: false,
              spinning: false
            },
            status: new Status(),
            versionModal,
            logModal,
            xraylogModal,
            backupModal,
            loadingTip: '{{ i18n "loading"}}',
            showAlert: false,
            showIp: false,
            ipLimitEnable: false,
        },
        methods: {
            loading(spinning, tip = '{{ i18n "loading"}}') {
                this.loadingStates.spinning = spinning;
                this.loadingTip = tip;
            },
            async getStatus() {
                try {
                    const msg = await HttpUtil.get('/panel/api/server/status');
                    if (msg.success) {
                        if (!this.loadingStates.fetched) {
                            this.loadingStates.fetched = true;
                        }

                        this.setStatus(msg.obj, true);
                    }
                } catch (e) {
                    console.error("Failed to get status:", e);
                }
            },
            setStatus(data) {
                this.status = new Status(data);
            },
            async openSelectV2rayVersion() {
                this.loading(true);
                const msg = await HttpUtil.get('/panel/api/server/getXrayVersion');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
                versionModal.show(msg.obj);
            },
            switchV2rayVersion(version) {
                this.$confirm({
                    title: '{{ i18n "pages.index.xraySwitchVersionDialog"}}',
                    content: '{{ i18n "pages.index.xraySwitchVersionDialogDesc"}}'.replace('#version#', version),
                    okText: '{{ i18n "confirm"}}',
                    class: themeSwitcher.currentTheme,
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: async () => {
                        versionModal.hide();
                        this.loading(true, '{{ i18n "pages.index.dontRefresh"}}');
                        await HttpUtil.post(`/panel/api/server/installXray/${version}`);
                        this.loading(false);
                    },
                });
            },
            updateGeofile(fileName) {
                const isSingleFile = !!fileName;
                this.$confirm({
                    title: '{{ i18n "pages.index.geofileUpdateDialog" }}',
                    content: isSingleFile
                        ? '{{ i18n "pages.index.geofileUpdateDialogDesc" }}'.replace("#filename#", fileName)
                        : '{{ i18n "pages.index.geofilesUpdateDialogDesc" }}',
                    okText: '{{ i18n "confirm"}}',
                    class: themeSwitcher.currentTheme,
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: async () => {
                        versionModal.hide();
                        this.loading(true, '{{ i18n "pages.index.dontRefresh"}}');
                        const url = isSingleFile 
                            ? `/panel/api/server/updateGeofile/${fileName}` 
                            : `/panel/api/server/updateGeofile`;
                        await HttpUtil.post(url);
                        this.loading(false);
                    },
                });
            },
            async stopXrayService() {
                this.loading(true);
                const msg = await HttpUtil.post('/panel/api/server/stopXrayService');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
            },
            async restartXrayService() {
                this.loading(true);
                const msg = await HttpUtil.post('/panel/api/server/restartXrayService');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
            },
            async openLogs(){
                logModal.loading = true;
                const msg = await HttpUtil.post('/panel/api/server/logs/'+logModal.rows,{level: logModal.level, syslog: logModal.syslog});
                if (!msg.success) {
                    return;
                }
                logModal.show(msg.obj);
                await PromiseUtil.sleep(500);
                logModal.loading = false;
            },
            async openXrayLogs(){
              xraylogModal.loading = true;
                const msg = await HttpUtil.post('/panel/api/server/xraylogs/'+xraylogModal.rows,{filter: xraylogModal.filter, showDirect: xraylogModal.showDirect, showBlocked: xraylogModal.showBlocked, showProxy: xraylogModal.showProxy});
                if (!msg.success) {
                    return;
                }
              xraylogModal.show(msg.obj);
                await PromiseUtil.sleep(500);
              xraylogModal.loading = false;
            },
            async openConfig() {
                this.loading(true);
                const msg = await HttpUtil.get('/panel/api/server/getConfigJson');
                this.loading(false);
                if (!msg.success) {
                    return;
                }
                txtModal.show('config.json', JSON.stringify(msg.obj, null, 2), 'config.json');
            },
            openBackup() {
              backupModal.show();
            },
            exportDatabase() {
                window.location = basePath.replace(/\/$/, '') + '/panel/api/server/getDb';
            },
            importDatabase() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.db';
                fileInput.addEventListener('change', async (event) => {
                    const dbFile = event.target.files[0];
                    if (dbFile) {
                        const formData = new FormData();
                        formData.append('db', dbFile);
                        backupModal.hide();
                        this.loading(true);
                        const uploadMsg = await HttpUtil.post('/panel/api/server/importDB', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data',
                            }
                        });
                        this.loading(false);
                        if (!uploadMsg.success) {
                            return;
                        }
                        this.loading(true);
                        const restartMsg = await HttpUtil.post("/panel/setting/restartPanel");
                        this.loading(false);
                        if (restartMsg.success) {
                            this.loading(true);
                            await PromiseUtil.sleep(5000);
                            location.reload();
                        }
                    }
                });
                fileInput.click();
            },
        },
        async mounted() {
            if (window.location.protocol !== "https:") {
                this.showAlert = true;
            }

            const msg = await HttpUtil.post('/panel/setting/defaultSettings');
            if (msg.success) {
              this.ipLimitEnable = msg.obj.ipLimitEnable;
            }

            while (true) {
                try {
                    await this.getStatus();
                } catch (e) {
                    console.error(e);
                }
                await PromiseUtil.sleep(2000);
            }
        },
    });
</script>
{{ template "page/body_end" .}}
